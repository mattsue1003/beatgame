<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯€å¥è‰²å½©æŒ‘æˆ° - åœ˜é«”éŠæˆ²ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto+Sans+TC', sans-serif;
            background-color: #0f172a;
            color: white;
            overflow-x: hidden;
        }

        .color-card {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(0.95);
            opacity: 0.3;
        }

        .color-card.active {
            transform: scale(1.08);
            opacity: 1;
            box-shadow: 0 0 50px currentColor;
            z-index: 10;
        }

        .pulse {
            animation: pulse-animation 0.5s infinite;
        }

        @keyframes pulse-animation {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .timer-bar {
            transition: width 1s linear;
        }

        select option {
            background-color: #1e293b;
            color: white;
        }

        .prep-overlay {
            animation: fadeIn 0.2s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* é¡è‰²é¸æ“‡å™¨æ¨£å¼ */
        .color-toggle {
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .color-toggle.inactive {
            opacity: 0.2;
            filter: grayscale(0.8);
            transform: scale(0.85);
        }
        .color-toggle.active::after {
            content: 'âœ“';
            position: absolute;
            bottom: -4px;
            right: -4px;
            background: #10b981;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            border: 2px solid #0f172a;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">

    <!-- é ‚éƒ¨æ¨™é¡Œ -->
    <div class="w-full max-w-4xl text-center mb-6">
        <h1 class="text-4xl md:text-6xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-fuchsia-500">
            ç¯€å¥è‰²å½©æŒ‘æˆ°
        </h1>
        <p class="text-slate-400 text-lg">è‡ªè¨‚é¡è‰²æ± èˆ‡å°å¼•ç‰ˆæœ¬</p>
    </div>

    <!-- éŠæˆ²ä¸»å€åŸŸ -->
    <div class="w-full max-w-6xl bg-slate-800/50 rounded-3xl p-6 md:p-8 border border-slate-700 shadow-2xl relative">
        
        <!-- é å‚™ç•«é¢ç–ŠåŠ å±¤ -->
        <div id="prepLayer" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-slate-900/95 rounded-3xl prep-overlay">
            <div id="prepText" class="text-7xl md:text-9xl font-black text-white text-center drop-shadow-2xl">
                æº–å‚™ä¸­
            </div>
        </div>

        <!-- ç¬¬ä¸€æ’ï¼šæ ¸å¿ƒè¨­å®š -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="flex flex-col space-y-2">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-tighter">èƒŒæ™¯éŸ³æ¨‚æ¨¡å¼</label>
                <select id="musicMode" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm text-cyan-400 font-bold focus:outline-none focus:border-cyan-500">
                    <option value="metronome">åŸºç¤ç¯€æ‹å™¨æ¨¡å¼</option>
                    <option value="drum">å°ˆæ¥­é¼“é»æ¨¡å¼ (å¯èª¿é€Ÿ)</option>
                </select>
            </div>

            <div class="flex flex-col space-y-2">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-tighter">é€Ÿåº¦ (BPM)</label>
                <div class="flex items-center space-x-3 bg-slate-900/50 p-2 rounded-xl border border-slate-700/50">
                    <input type="range" id="bpmRange" min="40" max="180" value="100" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
                    <span id="bpmValue" class="text-xl font-mono font-bold text-cyan-400 w-10">100</span>
                </div>
            </div>

            <div class="flex flex-col space-y-2">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-tighter">å¾ªç’°æ‹æ•¸</label>
                <div class="flex bg-slate-900 rounded-xl p-1 h-10">
                    <button onclick="setBeats(4)" id="btnBeats4" class="flex-1 rounded-lg font-bold transition bg-cyan-600 text-white">4 æ‹</button>
                    <button onclick="setBeats(8)" id="btnBeats8" class="flex-1 rounded-lg font-bold transition text-slate-400">8 æ‹</button>
                </div>
            </div>

            <div class="flex flex-col space-y-2">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-tighter">æŒ‘æˆ°æ™‚é–“ (ç§’)</label>
                <input type="number" id="gameDuration" value="60" min="10" max="300" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-white font-bold focus:outline-none focus:border-cyan-500">
            </div>
        </div>

        <!-- ç¬¬äºŒæ’ï¼šé€²éšè‡ªè¨‚ (èªéŸ³èˆ‡é¡è‰²é¸æ“‡) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 border-t border-slate-700/50 pt-6">
            <!-- èªéŸ³ -->
            <div class="flex flex-col space-y-2">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-tighter">é¸æ“‡äººè²</label>
                <select id="voiceSelect" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-cyan-500 w-full">
                    <option value="">è¼‰å…¥èªéŸ³ä¸­...</option>
                </select>
            </div>
            <!-- é¡è‰²æ±  -->
            <div class="flex flex-col space-y-2">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-tighter">é¡è‰²æ± é¸æ“‡ (é»æ“Šåˆ‡æ›)</label>
                <div id="colorPickerContainer" class="flex flex-wrap gap-3">
                    <!-- ç”± JS ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ç‹€æ…‹æŒ‡ç¤ºç‡ˆ -->
        <div class="flex flex-col items-center mb-6">
            <div id="phaseIndicator" class="text-3xl md:text-5xl font-black mb-4 transition-all duration-300 text-slate-500">
                é»æ“Šé–‹å§‹é€²è¡ŒæŒ‘æˆ°
            </div>
            <div class="w-full h-3 bg-slate-900 rounded-full overflow-hidden border border-slate-700">
                <div id="gameTimerBar" class="timer-bar h-full bg-gradient-to-r from-cyan-500 to-blue-500 w-full"></div>
            </div>
        </div>

        <!-- é¡è‰²å¡ç‰‡é¡¯ç¤ºå€ -->
        <div id="colorContainer" class="grid grid-cols-4 gap-3 md:gap-5 mb-8">
            <!-- ç”± JS ç”Ÿæˆ -->
        </div>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <div class="flex justify-center space-x-6">
            <button id="startBtn" class="px-12 py-4 bg-emerald-500 hover:bg-emerald-400 text-white rounded-2xl font-black text-xl shadow-lg shadow-emerald-500/20 transition-all active:scale-95">
                é–‹å§‹æŒ‘æˆ°
            </button>
            <button id="stopBtn" class="hidden px-12 py-4 bg-rose-500 hover:bg-rose-400 text-white rounded-2xl font-black text-xl shadow-lg shadow-rose-500/20 transition-all active:scale-95">
                åœæ­¢
            </button>
        </div>
    </div>

    <div class="mt-8 flex flex-col items-center space-y-2 text-slate-500 text-sm">
        <p>ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥è‡ªç”±é¸æ“‡æƒ³è¦å‡ºç¾çš„é¡è‰²ï¼Œä¸¦æ­é… 8 æ‹èªéŸ³æŒ‡ä»¤å°æ‹ï¼</p>
        <div class="flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
            <span>è‹¥å‹¾é¸å¤šå€‹é¡è‰²ï¼ŒéŠæˆ²æœƒå¾ä¸­éš¨æ©ŸæŠ½å–ã€‚</span>
        </div>
    </div>

    <script>
        const COLORS = [
            { id: 0, name: 'ç´…', bg: 'bg-red-500', color: '#ef4444', active: true },
            { id: 1, name: 'é»‘', bg: 'bg-black', color: '#000000', text: 'text-white', active: true },
            { id: 2, name: 'ç¶ ', bg: 'bg-emerald-500', color: '#10b981', active: true },
            { id: 3, name: 'é»ƒ', bg: 'bg-yellow-400', color: '#facc15', active: true },
            { id: 4, name: 'ç´«', bg: 'bg-purple-500', color: '#a855f7', active: true },
            { id: 5, name: 'æ©˜', bg: 'bg-orange-500', color: '#f97316', active: true },
            { id: 6, name: 'ç²‰', bg: 'bg-pink-400', color: '#f472b6', active: true },
            { id: 7, name: 'è—', bg: 'bg-cyan-400', color: '#22d3ee', active: true },
            { id: 8, name: 'ç™½', bg: 'bg-white', color: '#ffffff', text: 'text-black', active: true }
        ];

        const PREP_PHRASES = [
            "æˆ‘å”¸", "ä½ å”¸", "æˆ‘å”¸", "ä½ åš",
            "å‹•å£", "å‹•æ‰‹", "æº–å‚™", "é–‹å§‹"
        ];

        let bpm = 100;
        let beatsPerCycle = 4; 
        let isPlaying = false;
        let isPreparing = false;
        let currentStep = -1; 
        let prepStep = 0;
        let currentSequence = [];
        let gameTimer = null;
        let remainingTime = 60;
        let beatInterval = null;

        // Audio & Speech
        let audioCtx = null;
        const synth = window.speechSynthesis;
        let availableVoices = [];
        let selectedVoice = null;

        // DOM
        const musicMode = document.getElementById('musicMode');
        const voiceSelect = document.getElementById('voiceSelect');
        const colorContainer = document.getElementById('colorContainer');
        const colorPickerContainer = document.getElementById('colorPickerContainer');
        const bpmRange = document.getElementById('bpmRange');
        const bpmValue = document.getElementById('bpmValue');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const phaseIndicator = document.getElementById('phaseIndicator');
        const gameTimerBar = document.getElementById('gameTimerBar');
        const gameDurationInput = document.getElementById('gameDuration');
        const prepLayer = document.getElementById('prepLayer');
        const prepText = document.getElementById('prepText');

        function init() {
            renderCards();
            renderColorPickers();
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
            bpmRange.addEventListener('input', (e) => {
                bpm = parseInt(e.target.value);
                bpmValue.textContent = bpm;
                if (isPlaying) resetBeatInterval();
            });
            startBtn.addEventListener('click', startGame);
            stopBtn.addEventListener('click', stopGame);
        }

        function loadVoices() {
            availableVoices = synth.getVoices();
            if (availableVoices.length === 0) return;
            voiceSelect.innerHTML = '';
            const zhVoices = availableVoices.filter(v => v.lang.includes('zh') || v.lang.includes('TW') || v.lang.includes('HK'));
            const others = availableVoices.filter(v => !v.lang.includes('zh'));
            const allSorted = [...zhVoices, ...others];
            allSorted.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                if (voice.lang === 'zh-TW' && (voice.name.includes('Mei-Jia') || voice.name.includes('Google'))) option.selected = true;
                voiceSelect.appendChild(option);
            });
            updateSelectedVoice();
        }

        voiceSelect.addEventListener('change', updateSelectedVoice);
        function updateSelectedVoice() {
            selectedVoice = availableVoices.find(v => v.name === voiceSelect.value);
        }

        function setBeats(n) {
            if (isPlaying) return;
            beatsPerCycle = n;
            document.getElementById('btnBeats4').className = n === 4 ? 'flex-1 rounded-lg font-bold transition bg-cyan-600 text-white' : 'flex-1 rounded-lg font-bold transition text-slate-400';
            document.getElementById('btnBeats8').className = n === 8 ? 'flex-1 rounded-lg font-bold transition bg-cyan-600 text-white' : 'flex-1 rounded-lg font-bold transition text-slate-400';
            renderCards();
        }

        function renderColorPickers() {
            colorPickerContainer.innerHTML = '';
            COLORS.forEach(color => {
                const div = document.createElement('div');
                div.className = `color-toggle w-10 h-10 rounded-full border-2 border-slate-700 shadow-md ${color.bg} ${color.active ? 'active' : 'inactive'}`;
                div.title = color.name;
                div.onclick = () => {
                    if (isPlaying) return;
                    // ç¢ºä¿è‡³å°‘ä¸€å€‹ active
                    const activeCount = COLORS.filter(c => c.active).length;
                    if (color.active && activeCount <= 1) return;
                    
                    color.active = !color.active;
                    div.className = `color-toggle w-10 h-10 rounded-full border-2 border-slate-700 shadow-md ${color.bg} ${color.active ? 'active' : 'inactive'}`;
                };
                colorPickerContainer.appendChild(div);
            });
        }

        function renderCards() {
            colorContainer.innerHTML = '';
            for (let i = 0; i < beatsPerCycle; i++) {
                const card = document.createElement('div');
                card.id = `card-${i}`;
                card.className = `color-card aspect-square rounded-2xl flex items-center justify-center bg-slate-700 border-4 border-slate-600 shadow-xl`;
                card.innerHTML = `<span class="text-3xl md:text-5xl font-black">?</span>`;
                colorContainer.appendChild(card);
            }
        }

        function createKick(time) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(150, time);
            osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.4);
            gain.gain.setValueAtTime(0.8, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.4);
            osc.start(time);
            osc.stop(time + 0.4);
        }

        function createSnare(time) {
            const noise = audioCtx.createBufferSource();
            const bufferSize = audioCtx.sampleRate * 0.1;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            noise.buffer = buffer;
            const noiseFilter = audioCtx.createBiquadFilter();
            noiseFilter.type = 'highpass';
            noiseFilter.frequency.value = 1000;
            noise.connect(noiseFilter);
            const noiseGain = audioCtx.createGain();
            noiseFilter.connect(noiseGain);
            noiseGain.connect(audioCtx.destination);
            noiseGain.gain.setValueAtTime(0.2, time);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
            noise.start(time);
            noise.stop(time + 0.2);
        }

        function playSoundPattern(stepInCycle) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;

            if (musicMode.value === 'metronome') {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.value = (stepInCycle % beatsPerCycle === 0) ? 880 : 440;
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else {
                const beatInCycle = stepInCycle % 4;
                if (beatInCycle === 0 || beatInCycle === 2) createKick(now);
                else createSnare(now);
            }
        }

        function speakText(text) {
            synth.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            if (selectedVoice) utter.voice = selectedVoice;
            utter.lang = 'zh-TW';
            let rateScale = bpm / 90;
            utter.rate = Math.min(Math.max(rateScale, 1.4), 2.5); 
            setTimeout(() => synth.speak(utter), 5);
        }

        function generateSequence() {
            currentSequence = [];
            const activeColors = COLORS.filter(c => c.active);
            for (let i = 0; i < beatsPerCycle; i++) {
                currentSequence.push(activeColors[Math.floor(Math.random() * activeColors.length)]);
            }
        }

        function updateUI() {
            if (isPreparing) {
                prepLayer.classList.remove('hidden');
                const phrase = PREP_PHRASES[prepStep];
                prepText.textContent = phrase;
                
                if (prepStep < 4) {
                    prepText.className = "text-7xl md:text-9xl font-black text-cyan-400 text-center";
                } else {
                    prepText.className = "text-7xl md:text-9xl font-black text-emerald-400 text-center";
                }
                
                speakText(phrase);
                playSoundPattern(prepStep);
                return;
            }

            prepLayer.classList.add('hidden');
            const totalSteps = beatsPerCycle * 2;
            const cycleStep = currentStep % totalSteps;
            
            if (cycleStep < beatsPerCycle) {
                phaseIndicator.textContent = 'ğŸ‘€ è½ä¸€è½ï¼Œè¨˜ä¸‹ä¾†';
                phaseIndicator.className = 'text-3xl md:text-5xl font-black mb-4 text-cyan-400';
                const colorData = currentSequence[cycleStep];
                document.querySelectorAll('.color-card').forEach((card, idx) => {
                    const data = currentSequence[idx];
                    if (idx === cycleStep) {
                        const textColor = data.text || 'text-white';
                        card.className = `color-card active aspect-square rounded-2xl flex items-center justify-center ${data.bg} border-white ${textColor} shadow-xl`;
                        card.innerHTML = `<span class="text-4xl md:text-6xl font-black">${data.name}</span>`;
                        speakText(data.name);
                    } else {
                        card.className = `color-card aspect-square rounded-2xl flex items-center justify-center ${data.bg} border-transparent text-white/20`;
                        card.innerHTML = `<span class="text-2xl md:text-4xl font-bold">${data.name}</span>`;
                    }
                });
            } else {
                const echoStep = cycleStep - beatsPerCycle;
                phaseIndicator.textContent = 'ğŸ—£ï¸ æ›ä½ å€‘å”¸ï¼';
                phaseIndicator.className = 'text-3xl md:text-5xl font-black mb-4 text-fuchsia-400 pulse';
                document.querySelectorAll('.color-card').forEach((card, idx) => {
                    if (idx === echoStep) {
                        card.className = `color-card active aspect-square rounded-2xl flex items-center justify-center bg-white border-fuchsia-500 text-slate-900 shadow-xl`;
                        card.innerHTML = `<span class="text-4xl md:text-6xl font-black">?</span>`;
                    } else {
                        card.className = `color-card aspect-square rounded-2xl flex items-center justify-center bg-slate-900 border-transparent text-slate-700`;
                        card.innerHTML = `<span class="text-2xl md:text-4xl font-bold">?</span>`;
                    }
                });
            }
            playSoundPattern(cycleStep);
        }

        function resetBeatInterval() {
            if (beatInterval) clearInterval(beatInterval);
            const msPerBeat = (60 / bpm) * 1000;
            beatInterval = setInterval(() => {
                if (isPreparing) {
                    prepStep++;
                    if (prepStep >= 8) {
                        isPreparing = false;
                        currentStep = 0;
                        generateSequence();
                        startMainTimer();
                    }
                } else {
                    currentStep++;
                    if (currentStep % (beatsPerCycle * 2) === 0) generateSequence();
                }
                updateUI();
            }, msPerBeat);
        }

        function startMainTimer() {
            remainingTime = parseInt(gameDurationInput.value) || 60;
            const initialTime = remainingTime;
            gameTimer = setInterval(() => {
                remainingTime--;
                const percent = (remainingTime / initialTime) * 100;
                gameTimerBar.style.width = `${percent}%`;
                if (remainingTime <= 0) {
                    stopGame();
                    phaseIndicator.textContent = 'ğŸ‰ æŒ‘æˆ°çµæŸï¼';
                    phaseIndicator.className = 'text-3xl md:text-5xl font-black mb-4 text-emerald-400';
                }
            }, 1000);
        }

        function startGame() {
            if (isPlaying) return;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            synth.cancel();
            isPlaying = true;
            isPreparing = true;
            prepStep = 0;
            currentStep = -1;
            
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            gameDurationInput.disabled = true;
            musicMode.disabled = true;
            voiceSelect.disabled = true;

            updateUI(); // ç«‹å³è§¸ç™¼ç¬¬ä¸€æ‹
            resetBeatInterval();
        }

        function stopGame() {
            isPlaying = false;
            isPreparing = false;
            clearInterval(beatInterval);
            clearInterval(gameTimer);
            synth.cancel(); 
            prepLayer.classList.add('hidden');
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            gameDurationInput.disabled = false;
            musicMode.disabled = false;
            voiceSelect.disabled = false;
            currentStep = -1;
            renderCards();
            phaseIndicator.textContent = 'æº–å‚™å¥½äº†å—ï¼Ÿ';
            phaseIndicator.className = 'text-3xl md:text-5xl font-black mb-4 text-slate-500';
            gameTimerBar.style.width = '100%';
        }

        init();
    </script>
</body>
</html>
